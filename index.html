<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FSM thermostat: Thermostat with FSM and ADC</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">FSM thermostat
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Thermostat with FSM and ADC </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This project implements a thermostat with an analog LM35 temperature sensor, and 2 LEDs. The HW configuration is shown in the following picture:</p>
<div class="image">
<img src="fsm_thermostat_bb.png" alt=""/>
<div class="caption">
HW Thersmostat</div></div>
   <p>The system uses an FSM to manage the different states of the system and hardware. This picture shows the FSM of the system:</p>
<div class="image">
<img src="fsm_thermostat.png" alt=""/>
<div class="caption">
FSM Thersmostat</div></div>
   <p>The thermostat makes a measurement every time its timer is triggered. The measurement is done by the ADC peripheral. The ADC is configured to sample the temperature sensor in single mode. The timer is configured in the <code>PORT</code> file of the system.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter </th><th class="markdownTableHeadNone">Value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Define label </td><td class="markdownTableBodyNone">THERMOSTAT_MEASUREMENT_TIMER  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Timer </td><td class="markdownTableBodyNone">TIM2  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Interrupt </td><td class="markdownTableBodyNone"><a class="el" href="interr_8c.html#a38ad4725462bdc5e86c4ead4f04b9fc2" title="Interrupt service routine for the TIM2 timer.">TIM2_IRQHandler()</a>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Time interval </td><td class="markdownTableBodyNone">1 second  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Priority </td><td class="markdownTableBodyNone">2  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Subpriority </td><td class="markdownTableBodyNone">0  </td></tr>
</table>
<p>You can generate as many thermostat as you want by creating a new FSM and assigning the corresponding peripherals to the system. The system which is implemented in the <code><a class="el" href="main_8c.html" title="Basic FSM reading analog data from a linear thermistor LM35.">main.c</a></code> file. The system uses the following peripherals:</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Temperature sensor</h1>
<p>The temperature sensor used in the system is the LM35 (see <a href="https://www.ti.com/product/es-mx/LM35">LM35 datasheet</a>). The sensor is located in the shield provided by the university. The sensor is connected to the pin <code>PA0</code>. The sensor is configured as an analog input with no push-pull resistor. The sensor is sampled in single mode with a sampling period given by the interruptions of a timer. All the configurations of the ADC are by default. The ADC is configured to interrupt when the conversion is completed. The ADC is configured with the following settings:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter </th><th class="markdownTableHeadNone">Value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Variable name </td><td class="markdownTableBodyNone">temp_sensor_thermostat  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pin </td><td class="markdownTableBodyNone">PA0 (A0 on Nucleo)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ADC </td><td class="markdownTableBodyNone">ADC1  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Channel </td><td class="markdownTableBodyNone">0  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Mode </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pull up/ down </td><td class="markdownTableBodyNone">No push no pull  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ISR </td><td class="markdownTableBodyNone"><a class="el" href="interr_8c.html#a06406eadf297fa89a6eaf9586b227a69" title="Interrupt service routine for all the ADCs.">ADC_IRQHandler()</a>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Priority </td><td class="markdownTableBodyNone">1  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Subpriority </td><td class="markdownTableBodyNone">0  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md2"></a>
LEDs</h1>
<p>There are two LEDs in the system. The first LED is the <code>led_heater_active</code> (red) and the second LED is the <code>led_comfort_temperature</code> (blue). The <code>led_heater_active</code> is used to indicate that the temperature is below the threshold and the heater activates to warm the thermal system. The <code>led_comfort_temperature</code> is used to indicate that the temperature is above the threshold and the thermal system is off. The LEDs are within an RGB LED soldered in the shield provided by the university. The LEDs are connected to the pins <code>PB4</code> and <code>PB5</code>. The LEDs are configured as outputs with no push-pull resistor. The LEDs are turned on when the system starts. The LEDs are configured with the following settings:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter </th><th class="markdownTableHeadNone">Value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Variable name </td><td class="markdownTableBodyNone">led_comfort_temperature  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pin </td><td class="markdownTableBodyNone">PB5 (D4 on Nucleo)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Mode </td><td class="markdownTableBodyNone">Output  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pull up/ down </td><td class="markdownTableBodyNone">No push no pull  </td></tr>
</table>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter </th><th class="markdownTableHeadNone">Value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Variable name </td><td class="markdownTableBodyNone">led_heater_active  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pin </td><td class="markdownTableBodyNone">PB4 (D5 on Nucleo)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Mode </td><td class="markdownTableBodyNone">Output  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pull up/ down </td><td class="markdownTableBodyNone">No push no pull  </td></tr>
</table>
<p>There is also a third LED, the <code>led_on</code> (green), which is used to indicate that the system has started. This LED is not part of the system. The <code>led_on</code> is turned on when the system starts and is turned off after 500 ms. This LED can be disabled by commenting the line <code>#define USE_LED_ON</code> in the <code><a class="el" href="main_8c.html" title="Basic FSM reading analog data from a linear thermistor LM35.">main.c</a></code> file. The <code>led_on</code> is connected to the pin <code>PB3</code>.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter </th><th class="markdownTableHeadNone">Value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Variable name </td><td class="markdownTableBodyNone">led_on  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pin </td><td class="markdownTableBodyNone">PB3 (D3 on Nucleo)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Mode </td><td class="markdownTableBodyNone">Output  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pull up/ down </td><td class="markdownTableBodyNone">No push no pull  </td></tr>
</table>
<blockquote class="doxtable">
<p>[!WARNING] <b>If you want to use the <code>printf()</code> function using the SWO, you must change the pin of the <code>led_on</code> to another pin. The SWO pin is the <code>PB3</code> pin. If you use the <code>led_on</code>, the SWO pin will not work.</b> If you want to use the SWO, you must comment the line <code>#define USE_LED_ON</code> in the <code><a class="el" href="main_8c.html" title="Basic FSM reading analog data from a linear thermistor LM35.">main.c</a></code> file. <b>In this case, **if you are using the shield provided by the university, the pin <code>PB3</code> will be active turning on the <code>led_on</code> constantly and you won't see pure red or blue LEDs but a mix of colors instead.</b> </p>
</blockquote>
<p>Look at the following picture to see the shield provided by the university:</p>
<div class="image">
<img src="shield.png" alt=""/>
<div class="caption">
Shield</div></div>
   <h1><a class="anchor" id="autotoc_md3"></a>
References</h1>
<ul>
<li><b>[1]</b>: <a href="https://moodle.upm.es/titulaciones/oficiales/course/view.php?id=785#section-0">Documentation available in the Moodle of the course</a></li>
<li><b>[2]</b>: <a href="https://web.eece.maine.edu/~zhu/book/index.php">Embedded Systems with ARM Cortex-M Microcontrollers in Assembly Language and C (Fourth Edition)</a> for explanations and examples of use of the ARM Cortex-M microcontrollers in C with CMSIS.</li>
<li><b>[3]</b>: <a href="https://ingenio.upm.es/primo-explore/fulldisplay?docid=34UPM_ALMA51126621660004212&amp;context=L&amp;vid=34UPM_VU1&amp;lang=es_ES&amp;search_scope=TAB1_SCOPE1&amp;adaptor=Local%20Search%20Engine&amp;tab=tab1&amp;query=any,contains,Programming%20with%20STM32:%20Getting%20Started%20with%20the%20Nucleo%20Board%20and%20C%2FC%2B%2B&amp;offset=0">Programming with STM32: Getting Started with the Nucleo Board and C/C++</a> for examples of use of the STM32 microcontrollers with the HAL of ST.</li>
<li><b>[4]</b>: <a href="https://ingenio.upm.es/primo-explore/fulldisplay?docid=34UPM_ALMA2151866130004212&amp;context=L&amp;vid=34UPM_VU1&amp;lang=es_ES&amp;search_scope=TAB1_SCOPE1&amp;adaptor=Local%20Search%20Engine&amp;isFrbr=true&amp;tab=tab1&amp;query=any,contains,C%20Programming%20Language">The C Programming Language</a></li>
<li><b>[5]</b>: <a href="https://www.elektor.com/products/nucleo-boards-programming-with-the-stm32cubeide">Nucleo Boards Programming with th STM32CubeIDE</a> for examples of use of the STM32 microcontrollers with the STM32CubeIDE. </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
